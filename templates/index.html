<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</title>
    <link rel="icon" type="image/x-icon" href="/static/image/favicon.ico">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h1><span>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏ô</span>
        </div>
        {% if session.logged_in %}
         <div class="user-info top-right">
            ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, {{ session.username or 'Admin' }}!
            <a href="/logout" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
        {% else %}
            <a href="/login" class="login-btn top-right">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        {% endif %}

        <!-- search -->
        <div class="left-panel">
            <div class="search-and-stats">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... üîç ">
                    <div class="filters">
                        <!-- ‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥ -->
                        <select id="filter-river">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥)</option>
                            {% for river in unique_rivers %}
                            <option value="{{ river }}">{{ river }}</option>
                        {% endfor %}
                        </select>
                        <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î -->
                        <select id="filter-province">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)</option>
                            {% for province in unique_provinces %}
                            <option value="{{ province }}">{{ province }}</option>
                            {% endfor %}
                        </select>
                        <!-- ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ -->
                        <select id="filter-amphoe">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏≠‡∏≥‡πÄ‡∏†‡∏≠)</option>
                            {% for amphoe in unique_amphoes %}
                            <option value="{{ amphoe }}">{{ amphoe }}</option>
                            {% endfor %}
                        </select>
                        <!-- ‡∏ï‡∏≥‡∏ö‡∏• -->
                        <select id="filter-tambon">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≥‡∏ö‡∏•)</option>
                            {% for tambon in unique_tambons %}
                            <option value="{{ tambon }}">{{ tambon }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- stats -->
        <div class="stats">
            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div class="stat-card">
                <img src="/static/image/location.png" alt="location icon" style="width: 100px; margin-bottom: 10px;">
                <div class="number" id="total-stations">{{ stations|length }}</div>
                <div class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <!-- ‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥ -->
            <div class="stat-card">
                <img src="/static/image/river.png" alt="location icon" style="width: 100px; margin-bottom: 10px;">
                <div class="number" id="unique-rivers">{{ unique_rivers|length }}</div>
                <div class="label">‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥</div>
            </div>
            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
            <div class="stat-card">
                <img src="/static/image/research.png" alt="location icon" style="width: 100px; margin-bottom: 10px;">
                <div class="number" id="filtered-count">{{ stations|length }}</div>
                <div class="label">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>
            </div>
        </div>

        <!-- stations grid -->
        <div class="stations-grid" id="stations-grid">
            {% for station in stations %}
            <div class="station-card" 
                 data-river="{{ station.river }}" 
                 data-province="{{ station.province }}"
                 data-amphoe="{{ station.amphoe }}"
                 data-tambon="{{ station.tambon }}"
                 data-station="{{ station.station }}"
                 data-location="{{ station.location }}"
                 onclick="window.location.href='/station/{{ station.station }}'">
                <div class="station-header">
                    <span class="river-name">{{ station.river }}</span>
                    <span class="station-code">{{ station.station }}</span>
                </div>
                <div class="station-info">
                    <div class="info-row">
                        <img src="/static/image/pin.png" alt="location icon" style="width: 20px;"><span class="info-label">&nbsp; ‡∏ï‡∏≥‡∏ö‡∏•:</span>
                        <span class="info-value">{{ station.tambon }}</span>
                    </div>
                    <div class="info-row">
                        <img src="/static/image/bank.png" alt="location icon" style="width: 20px;">
                        <span class="info-label">&nbsp; ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</span>
                        <span class="info-value">{{ station.amphoe }}</span>
                    </div>
                    <div class="info-row">
                        <img src="/static/image/book.png" alt="location icon" style="width: 20px;">
                        <span class="info-label">&nbsp; ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                        <span class="info-value">{{ station.province }}</span>
                    </div>
                    <div class="location">
                        <img src="/static/image/placeholder.png" alt="location icon" style="width: 20px;">
                        <strong>&nbsp; ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á:</strong> {{ station.location }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="no-results" id="no-results" style="display: none;">
            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </div>
    </div>
        {% if session.logged_in %}
            <a href="/static/pages/addstation.html">
            <button class="floating-button" id="add"> + </button>
            </a>
        {% endif %}
    <script id>
        // Location hierarchy data from backend
        const locationHierarchy = {{ location_hierarchy|tojson }};
        
        const searchInput = document.getElementById('search-input');
        const filterRiver = document.getElementById('filter-river');
        const filterProvince = document.getElementById('filter-province');
        const filterAmphoe = document.getElementById('filter-amphoe');
        const filterTambon = document.getElementById('filter-tambon');
        const stationsGrid = document.getElementById('stations-grid');
        const noResults = document.getElementById('no-results');
        const filteredCount = document.getElementById('filtered-count');

        const stationCards = Array.from(document.querySelectorAll('.station-card'));
        
        // Store original options for reset
        const allAmphoes = [
            {% for amphoe in unique_amphoes %}
            "{{ amphoe }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        const allTambons = [
            {% for tambon in unique_tambons %}
            "{{ tambon }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Update Amphoe dropdown based on selected Province
        function updateAmphoeDropdown() {
            const selectedProvince = filterProvince.value;
            const currentValue = filterAmphoe.value;
            
        // Clear amphoe dropdown
        filterAmphoe.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏≠‡∏≥‡πÄ‡∏†‡∏≠)</option>';       
            if (selectedProvince && locationHierarchy[selectedProvince]) {
                const amphoes = Object.keys(locationHierarchy[selectedProvince]).sort();
                amphoes.forEach(amphoe => {
                    const option = document.createElement('option');
                        option.value = amphoe;
                        option.textContent = amphoe;
                        filterAmphoe.appendChild(option);
                });
            } else if (selectedProvince) {
            // If no province selected, show all amphoes
            allAmphoes.forEach(amphoe => {
                const option = document.createElement('option');
                    option.value = amphoe;
                    option.textContent = amphoe;
                    filterAmphoe.appendChild(option);
            });
        }
            
        // Reset amphoe selection if current value is not in new list
        if (currentValue && !Array.from(filterAmphoe.options).some(opt => opt.value === currentValue)) {
            filterAmphoe.value = '';
        }
            
        // Trigger tambon update
        updateTambonDropdown();
        }
        
        // Update Tambon dropdown based on selected Amphoe
        function updateTambonDropdown() {
            const selectedProvince = filterProvince.value;
            const selectedAmphoe = filterAmphoe.value;
            const currentValue = filterTambon.value;
            
        // Clear tambon dropdown
        filterTambon.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≥‡∏ö‡∏•)</option>';
            
            if (selectedProvince && selectedAmphoe && 
                locationHierarchy[selectedProvince] && 
                locationHierarchy[selectedProvince][selectedAmphoe]) {
                // Show tambons in selected amphoe
                const tambons = locationHierarchy[selectedProvince][selectedAmphoe];
                tambons.forEach(tambon => {
                    const option = document.createElement('option');
                        option.value = tambon;
                        option.textContent = tambon;
                        filterTambon.appendChild(option);
                });
            } else if (selectedProvince && locationHierarchy[selectedProvince]) {
            // If only province selected, show all tambons in that province
            const allTambonsInProvince = new Set();
            Object.values(locationHierarchy[selectedProvince]).forEach(tambons => {
                tambons.forEach(t => allTambonsInProvince.add(t));
            });
            Array.from(allTambonsInProvince).sort().forEach(tambon => {
                const option = document.createElement('option');
                    option.value = tambon;
                    option.textContent = tambon;
                    filterTambon.appendChild(option);
            });
        } else {
        // If no filters, show all tambons
        allTambons.forEach(tambon => {
            const option = document.createElement('option');
                option.value = tambon;
                option.textContent = tambon;
                filterTambon.appendChild(option);
            });
        }
            
        // Reset tambon selection if current value is not in new list
        if (currentValue && !Array.from(filterTambon.options).some(opt => opt.value === currentValue)) {
            filterTambon.value = '';
        }
    }

    function filterStations() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedRiver = filterRiver.value;
        const selectedProvince = filterProvince.value;
        const selectedAmphoe = filterAmphoe.value;
        const selectedTambon = filterTambon.value;

        let visibleCount = 0;

        stationCards.forEach(card => {
            const river = card.dataset.river;
            const province = card.dataset.province;
            const amphoe = card.dataset.amphoe;
            const tambon = card.dataset.tambon;
            const station = card.dataset.station.toLowerCase();
            const location = card.dataset.location.toLowerCase();

            const matchesSearch = !searchTerm || 
                station.includes(searchTerm) || 
                river.toLowerCase().includes(searchTerm) ||
                location.includes(searchTerm);

            const matchesRiver = !selectedRiver || river === selectedRiver;
            const matchesProvince = !selectedProvince || province === selectedProvince;
            const matchesAmphoe = !selectedAmphoe || amphoe === selectedAmphoe;
            const matchesTambon = !selectedTambon || tambon === selectedTambon;

            if (matchesSearch && matchesRiver && matchesProvince && matchesAmphoe && matchesTambon) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        filteredCount.textContent = visibleCount;

        if (visibleCount === 0) {
            noResults.style.display = 'block';
            stationsGrid.style.display = 'none';
        } else {
            noResults.style.display = 'none';
            stationsGrid.style.display = 'grid';
        }
    }

    // Event listeners
    searchInput.addEventListener('input', filterStations);
    filterRiver.addEventListener('change', filterStations);
        
    filterProvince.addEventListener('change', function() {
        updateAmphoeDropdown();
        filterStations();
    });
    filterAmphoe.addEventListener('change', function() {
        updateTambonDropdown();
        filterStations();
    });
    filterTambon.addEventListener('change', filterStations);
    // Initialize dropdowns on page load
    updateAmphoeDropdown();
    </script>
</body>
</html>